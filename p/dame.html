<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dame Online</title>
<style>
  body {
    margin: 0;
    background: #333;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  .board {
    display: grid;
    grid-template-columns: repeat(8, 80px);
    grid-template-rows: repeat(8, 80px);
    border: 5px solid black;
  }
  .cell {
    width: 80px;
    height: 80px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .light { background: #ccc; }
  .dark  { background: #555; }

  .piece {
    width: 65px;
    height: 65px;
    border-radius: 50%;
    background-color: rgba(255,255,255,0.2);
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
  }
  .piece img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transform: rotate(0deg);
  }
  .selected {
    outline: 4px solid yellow;
  }
</style>
</head>
<body>

<div class="board" id="board"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA2foolYwDeoTrfkynuhJu44lb5qDXHFwg",
    authDomain: "auth-adfwc.firebaseapp.com",
    projectId: "auth-adfwc",
    storageBucket: "auth-adfwc.appspot.com",
    messagingSenderId: "221420792742",
    appId: "1:221420792742:web:f75515331cb4c5b4603d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const docRef = doc(db, "p", "dame");

  const boardElem = document.getElementById("board");

  const IMAGES = {
    1: "../b/weiß.png",
    2: "../b/schwarz.png",
    11: "../b/weiß.png",   // Dame benutzt dasselbe Bild, unterscheidet sich aber in den Regeln
    22: "../b/schwarz.png"
  };

  let gameState = {
    board: [],
    currentPlayer: 1,
    selected: null
  };

  function createInitialBoard() {
    const b = [];
    for(let r=0; r<8; r++) {
      b[r] = [];
      for(let c=0; c<8; c++) {
        if(r<3 && (r+c)%2 === 1) b[r][c] = 2;
        else if(r>4 && (r+c)%2 === 1) b[r][c] = 1;
        else b[r][c] = 0;
      }
    }
    return b;
  }

  function renderBoard() {
    boardElem.innerHTML = "";
    for(let r=0; r<8; r++) {
      for(let c=0; c<8; c++) {
        const cell = document.createElement("div");
        cell.classList.add("cell");
        cell.classList.add((r+c)%2 === 0 ? "light" : "dark");
        cell.dataset.row = r;
        cell.dataset.col = c;

        const val = gameState.board[r][c];
        if(val !== 0) {
          const piece = document.createElement("div");
          piece.classList.add("piece");
          const img = document.createElement("img");
          img.src = IMAGES[val];
          img.style.transform = `rotate(${Math.floor(Math.random()*4)*90}deg)`;
          piece.appendChild(img);

          if(gameState.selected && gameState.selected[0] === r && gameState.selected[1] === c) {
            piece.classList.add("selected");
          }

          cell.appendChild(piece);
        }

        boardElem.appendChild(cell);
      }
    }
  }

  function getMoves(from) {
    const [r,c] = from;
    const val = gameState.board[r][c];
    if(val === 0) return [];

    const isDame = val > 10;
    const player = val % 10;

    const dirs = isDame ? [[1,1],[1,-1],[-1,1],[-1,-1]] :
                (player === 1 ? [[-1,1],[-1,-1]] : [[1,1],[1,-1]]);

    const moves = [];

    for(const [dr, dc] of dirs) {
      let nr = r+dr;
      let nc = c+dc;

      if(isDame) {
        while(nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
          if(gameState.board[nr][nc] === 0) {
            moves.push([nr, nc]);
          } else {
            if(gameState.board[nr][nc]%10 !== player) {
              let afterR = nr+dr;
              let afterC = nc+dc;
              while(afterR >= 0 && afterR < 8 && afterC >= 0 && afterC < 8 && gameState.board[afterR][afterC] === 0) {
                moves.push([afterR, afterC, nr, nc]);  // optionaler Schlag
                afterR += dr;
                afterC += dc;
              }
            }
            break;
          }
          nr += dr;
          nc += dc;
        }
      } else {
        if(nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
          if(gameState.board[nr][nc] === 0) {
            moves.push([nr, nc]);
          } else if(gameState.board[nr][nc]%10 !== player) {
            const afterR = nr+dr;
            const afterC = nc+dc;
            if(afterR >= 0 && afterR < 8 && afterC >= 0 && afterC < 8 && gameState.board[afterR][afterC] === 0) {
              moves.push([afterR, afterC, nr, nc]);  // optionaler Schlag
            }
          }
        }
      }
    }

    return moves;
  }

  async function tryMove(toR, toC) {
    const [r,c] = gameState.selected;
    const val = gameState.board[r][c];
    const moves = getMoves([r,c]);

    for(const move of moves) {
      const [mr, mc] = move;
      if(mr === toR && mc === toC) {
        if(move.length === 4) {
          const [_,__,sr,sc] = move;
          gameState.board[sr][sc] = 0;  // Schlagen
        }

        gameState.board[toR][toC] = val;
        gameState.board[r][c] = 0;

        // Dame werden
        if(val === 1 && toR === 0) gameState.board[toR][toC] = 11;
        if(val === 2 && toR === 7) gameState.board[toR][toC] = 22;

        gameState.currentPlayer = (gameState.currentPlayer === 1) ? 2 : 1;
        gameState.selected = null;

        renderBoard();
        await saveGame();
        return;
      }
    }
    gameState.selected = null;
    renderBoard();
  }

  boardElem.addEventListener("click", async (e) => {
    const cell = e.target.closest(".cell");
    if(!cell) return;

    const r = parseInt(cell.dataset.row);
    const c = parseInt(cell.dataset.col);
    const val = gameState.board[r][c];

    if(gameState.selected) {
      await tryMove(r,c);
    } else if(val !== 0 && val%10 === gameState.currentPlayer) {
      gameState.selected = [r,c];
      renderBoard();
    }
  });

  async function saveGame() {
    await setDoc(docRef, {
      board: gameState.board,
      currentPlayer: gameState.currentPlayer
    });
  }

  async function loadGame() {
    const snap = await getDoc(docRef);
    if(snap.exists()) {
      const data = snap.data();
      gameState.board = data.board;
      gameState.currentPlayer = data.currentPlayer;
    } else {
      gameState.board = createInitialBoard();
      gameState.currentPlayer = 1;
      await saveGame();
    }
    gameState.selected = null;
    renderBoard();
  }

  onSnapshot(docRef, (snap) => {
    if(snap.exists()) {
      const data = snap.data();
      gameState.board = data.board;
      gameState.currentPlayer = data.currentPlayer;
      gameState.selected = null;
      renderBoard();
    }
  });

  loadGame();
</script>

</body>
</html>
