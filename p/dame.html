<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dame Online</title>
<style>
  body {
    margin: 0;
    background: #333;
    color: white;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .board {
    display: grid;
    grid-template-columns: repeat(8, 80px);
    grid-template-rows: repeat(8, 80px);
    border: 5px solid black;
    margin: 20px 0;
  }
  .cell {
    width: 80px;
    height: 80px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }
  .light { background: #ccc; }
  .dark  { background: #555; }

  .piece {
    width: 65px;
    height: 65px;
    border-radius: 50%;
    background-color: rgba(255,255,255,0.2);
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
  }
  .piece img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  .crown {
    position: absolute;
    font-size: 20px;
    top: 5px;
    right: 5px;
    pointer-events: none;
  }
  .status {
    margin: 10px;
    font-size: 18px;
  }
</style>
</head>
<body>

<div class="status" id="status">Lade...</div>
<div class="board" id="board"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA2foolYwDeoTrfkynuhJu44lb5qDXHFwg",
  authDomain: "auth-adfwc.firebaseapp.com",
  projectId: "auth-adfwc",
  storageBucket: "auth-adfwc.appspot.com",
  messagingSenderId: "221420792742",
  appId: "1:221420792742:web:f75515331cb4c5b4603d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const docRef = doc(db, "p", "dame");

const boardElement = document.getElementById("board");
const statusEl = document.getElementById("status");

const IMAGES = {
  1: "../b/wei√ü.png",
  2: "../b/schwarz.png",
  11: "../b/wei√ü.png",
  22: "../b/schwarz.png"
};

const gameState = {
  board: [],
  currentPlayer: 1,
  selected: null,
  playerColor: parseInt(localStorage.getItem("playerColor")) || null
};

if (gameState.playerColor === null) {
  const choice = confirm("M√∂chtest du als Wei√ü spielen? (Abbrechen = Schwarz)");
  gameState.playerColor = choice ? 1 : 2;
  localStorage.setItem("playerColor", gameState.playerColor);
}

function createInitialBoard() {
  const board = [];
  for (let r = 0; r < 8; r++) {
    board[r] = [];
    for (let c = 0; c < 8; c++) {
      if ((r + c) % 2 === 1) {
        if (r < 3) board[r][c] = 2;
        else if (r > 4) board[r][c] = 1;
        else board[r][c] = 0;
      } else {
        board[r][c] = 0;
      }
    }
  }
  return board;
}

async function saveGame() {
  await setDoc(docRef, {
    board: JSON.stringify(gameState.board),
    currentPlayer: gameState.currentPlayer
  });
}

function renderBoard() {
  boardElement.innerHTML = "";
  for (let r = 0; r < 8; r++) {
    for (let c = 0; c < 8; c++) {
      const cell = document.createElement("div");
      cell.className = "cell " + (((r + c) % 2 === 0) ? "light" : "dark");
      const stone = gameState.board[r][c];
      if (stone) {
        const img = document.createElement("img");
        img.src = IMAGES[stone];
        img.className = "piece";
        cell.appendChild(img);

        if (stone === 11 || stone === 22) {
          const crown = document.createElement("div");
          crown.className = "crown";
          crown.textContent = "üëë";
          cell.appendChild(crown);
        }
      }
      cell.onclick = () => handleClick(r, c);
      boardElement.appendChild(cell);
    }
  }
  const player = gameState.currentPlayer === 1 ? "Wei√ü" : "Schwarz";
  statusEl.textContent = `Du spielst als ${gameState.playerColor === 1 ? "Wei√ü" : "Schwarz"}. Am Zug: ${player}`;
}

function handleClick(r, c) {
  if (gameState.currentPlayer !== gameState.playerColor) return;

  const selected = gameState.selected;
  const stone = gameState.board[r][c];

  if (selected) {
    const [sr, sc] = selected;
    if (gameState.board[sr][sc] && isValidMove(sr, sc, r, c)) {
      gameState.board[r][c] = gameState.board[sr][sc];
      gameState.board[sr][sc] = 0;

      // Dame-Status pr√ºfen
      if (gameState.board[r][c] === 1 && r === 0) gameState.board[r][c] = 11;
      if (gameState.board[r][c] === 2 && r === 7) gameState.board[r][c] = 22;

      gameState.currentPlayer = (gameState.currentPlayer === 1) ? 2 : 1;
      gameState.selected = null;
      saveGame();
    } else {
      gameState.selected = null;
    }
  } else {
    if (stone && (stone % 10) === gameState.playerColor) {
      gameState.selected = [r, c];
    }
  }
  renderBoard();
}

function isValidMove(sr, sc, r, c) {
  const piece = gameState.board[sr][sc];
  if (!piece) return false;
  const direction = piece === 1 ? -1 : (piece === 2 ? 1 : 0);

  // Dame kann beliebig ziehen
  if (piece >= 10) return isValidQueenMove(sr, sc, r, c);

  // Normale Figuren: einen Schritt diagonal
  if (Math.abs(sr - r) === 1 && Math.abs(sc - c) === 1 && (r - sr) === direction && gameState.board[r][c] === 0) {
    return true;
  }

  // Schlagen
  if (Math.abs(sr - r) === 2 && Math.abs(sc - c) === 2) {
    const mr = (sr + r) / 2;
    const mc = (sc + c) / 2;
    const midStone = gameState.board[mr][mc];
    if (midStone && (midStone % 10) !== (piece % 10) && gameState.board[r][c] === 0) {
      gameState.board[mr][mc] = 0;
      return true;
    }
  }
  return false;
}

function isValidQueenMove(sr, sc, r, c) {
  if (Math.abs(sr - r) !== Math.abs(sc - c)) return false;
  const stepR = (r - sr) / Math.abs(r - sr);
  const stepC = (c - sc) / Math.abs(c - sc);

  let i = sr + stepR;
  let j = sc + stepC;
  let opponentHit = false;

  while (i !== r && j !== c) {
    const stone = gameState.board[i][j];
    if (stone) {
      if ((stone % 10) === (gameState.board[sr][sc] % 10)) return false;
      if (opponentHit) return false;
      opponentHit = true;
    }
    i += stepR;
    j += stepC;
  }

  if (gameState.board[r][c] !== 0) return false;
  if (opponentHit) {
    const hitR = sr + stepR;
    const hitC = sc + stepC;
    gameState.board[hitR][hitC] = 0;
  }

  return true;
}

function initGame() {
  onSnapshot(docRef, (snapshot) => {
    const data = snapshot.data();
    if (data) {
      gameState.board = JSON.parse(data.board);
      gameState.currentPlayer = data.currentPlayer;
      gameState.selected = null;
      renderBoard();
    } else {
      gameState.board = createInitialBoard();
      gameState.currentPlayer = 1;
      saveGame();
    }
  });
}

initGame();
</script>

</body>
</html>
