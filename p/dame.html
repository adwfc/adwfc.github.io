<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dame Online</title>
  <style>
    body {
      margin: 0;
      background: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
    }
    .info {
      color: white;
      margin-bottom: 10px;
      font-family: sans-serif;
      font-size: 16px;
      text-align: center;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      aspect-ratio: 1 / 1;
      width: 90vmin;
      max-width: 600px;
      border: 4px solid black;
    }
    .cell {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .light { background: #f0d9b5; }
    .dark  { background: #b58863; }
    .stone {
      width: 80%;
      height: 80%;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2em;
      background: none;
    }
    .selected {
      outline: 3px solid yellow;
      border-radius: 50%;
    }
  </style>
</head>
<body>

<div class="info" id="status">LÃ¤dt...</div>
<div class="board" id="board"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA2foolYwDeoTrfkynuhJu44lb5qDXHFwg",
    authDomain: "auth-adfwc.firebaseapp.com",
    projectId: "auth-adfwc",
    storageBucket: "auth-adfwc.appspot.com",
    messagingSenderId: "221420792742",
    appId: "1:221420792742:web:f75515331cb4c5b4603d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const docRef = doc(db, "p", "dame");

  const boardElement = document.getElementById("board");
  const statusElement = document.getElementById("status");

  const SYMBOLS = {
    1: "âšª",
    2: "âš«",
    11: "ðŸ‘‘âšª",
    22: "ðŸ‘‘âš«"
  };

  const gameState = {
    board: [],
    currentPlayer: 1,
    selected: null
  };

  let playerSide = localStorage.getItem("dame_player");
  if (!playerSide) {
    playerSide = prompt("Bist du WeiÃŸ (1) oder Schwarz (2)? Gib 1 oder 2 ein:");
    if (playerSide !== "1" && playerSide !== "2") playerSide = "1";
    localStorage.setItem("dame_player", playerSide);
  }
  playerSide = parseInt(playerSide);

  function createInitialBoard() {
    const board = [];
    for (let r = 0; r < 8; r++) {
      board[r] = [];
      for (let c = 0; c < 8; c++) {
        if ((r + c) % 2 === 1) {
          if (r < 3) board[r][c] = 2;
          else if (r > 4) board[r][c] = 1;
          else board[r][c] = 0;
        } else {
          board[r][c] = 0;
        }
      }
    }
    return board;
  }

  async function saveGame() {
    await setDoc(docRef, {
      board: JSON.stringify(gameState.board),
      currentPlayer: gameState.currentPlayer
    });
  }

  function renderBoard() {
    boardElement.innerHTML = "";
    statusElement.textContent = 
      `Du spielst ${playerSide === 1 ? "âšª WeiÃŸ" : "âš« Schwarz"} â€” ` + 
      `${gameState.currentPlayer === 1 ? "âšª WeiÃŸ am Zug" : "âš« Schwarz am Zug"}`;

    for (let r = 0; r < 8; r++) {
      for (let c = 0; c < 8; c++) {
        const cell = document.createElement("div");
        cell.className = "cell " + (((r + c) % 2 === 0) ? "light" : "dark");
        const stone = gameState.board[r][c];
        if (stone) {
          const div = document.createElement("div");
          div.className = "stone" + (gameState.selected?.r === r && gameState.selected?.c === c ? " selected" : "");
          div.textContent = SYMBOLS[stone];
          div.onclick = () => handleClick(r, c);
          cell.appendChild(div);
        } else {
          cell.onclick = () => handleClick(r, c);
        }
        boardElement.appendChild(cell);
      }
    }
  }

  function handleClick(r, c) {
    if (gameState.currentPlayer !== playerSide) return;

    const sel = gameState.selected;
    const stone = gameState.board[r][c];

    if (stone && (stone % 10) === playerSide) {
      gameState.selected = { r, c };
      renderBoard();
      return;
    }

    if (sel) {
      const sr = sel.r;
      const sc = sel.c;
      const piece = gameState.board[sr][sc];
      const dr = r - sr;
      const dc = c - sc;

      if (gameState.board[r][c] === 0) {
        if (piece >= 10) {  
          if (Math.abs(dr) === Math.abs(dc)) {
            const result = checkDameCapture(sr, sc, r, c);
            if (result.canMove) {
              if (result.captured) gameState.board[result.captured.r][result.captured.c] = 0;
              gameState.board[r][c] = piece;
              gameState.board[sr][sc] = 0;
              endTurn();
            }
          }
        } else {  
          const forward = (playerSide === 1) ? -1 : 1;
          if (Math.abs(dr) === 1 && Math.abs(dc) === 1 && dr === forward) {
            gameState.board[r][c] = piece;
            gameState.board[sr][sc] = 0;
            if ((playerSide === 1 && r === 0) || (playerSide === 2 && r === 7)) {
              gameState.board[r][c] = 10 + playerSide;
            }
            endTurn();
          }
          if (Math.abs(dr) === 2 && Math.abs(dc) === 2) {
            const mr = sr + dr / 2;
            const mc = sc + dc / 2;
            const middlePiece = gameState.board[mr][mc];
            if (middlePiece && (middlePiece % 10) !== playerSide) {
              gameState.board[r][c] = piece;
              gameState.board[sr][sc] = 0;
              gameState.board[mr][mc] = 0;
              if ((playerSide === 1 && r === 0) || (playerSide === 2 && r === 7)) {
                gameState.board[r][c] = 10 + playerSide;
              }
              endTurn();
            }
          }
        }
      }
    }
  }

  function checkDameCapture(sr, sc, r, c) {
    const stepR = (r > sr) ? 1 : -1;
    const stepC = (c > sc) ? 1 : -1;
    let tr = sr + stepR;
    let tc = sc + stepC;
    let captured = null;
    while (tr !== r && tc !== c) {
      const field = gameState.board[tr][tc];
      if (field !== 0) {
        if (!captured && (field % 10) !== playerSide) {
          captured = { r: tr, c: tc };
        } else {
          return { canMove: false };
        }
      }
      tr += stepR;
      tc += stepC;
    }
    return { canMove: true, captured };
  }

  function endTurn() {
    gameState.selected = null;
    gameState.currentPlayer = (gameState.currentPlayer === 1) ? 2 : 1;
    renderBoard();
    saveGame();
  }

  function startNewGame() {
    gameState.board = createInitialBoard();
    gameState.currentPlayer = 1;
    saveGame();
  }

  async function loadGame() {
    const snap = await getDoc(docRef);
    if (snap.exists() && snap.data()?.board) {
      try {
        gameState.board = JSON.parse(snap.data().board);
        if (!Array.isArray(gameState.board)) throw new Error("Kein gÃ¼ltiges Spielbrett.");
        gameState.currentPlayer = snap.data().currentPlayer ?? 1;
      } catch (e) {
        startNewGame();
      }
    } else {
      startNewGame();
    }
    renderBoard();
  }

  loadGame();

  onSnapshot(docRef, (snapshot) => {
    const data = snapshot.data();
    if (data && typeof data.board === "string") {
      try {
        gameState.board = JSON.parse(data.board);
        gameState.currentPlayer = data.currentPlayer ?? 1;
        renderBoard();
      } catch (e) { }
    }
  });

</script>

</body>
</html>
