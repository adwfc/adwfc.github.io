<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dame Online mit Spielerbindung</title>
<style>
  body {
    margin: 0;
    background: #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    color: white;
    font-family: sans-serif;
  }
  #status {
    margin-bottom: 10px;
    font-size: 1.2rem;
  }
  .board {
    display: grid;
    grid-template-columns: repeat(8, 80px);
    grid-template-rows: repeat(8, 80px);
    border: 5px solid black;
  }
  .cell {
    width: 80px;
    height: 80px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .light {
    background: #ccc;
  }
  .dark {
    background: #555;
  }
  .stone {
    width: 50px;
    height: 50px;
    cursor: pointer;
  }
  .selected {
    outline: 3px solid yellow;
  }
</style>
</head>
<body>

<div id="status">Verbinde...</div>
<div class="board" id="board"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA2foolYwDeoTrfkynuhJu44lb5qDXHFwg",
    authDomain: "auth-adfwc.firebaseapp.com",
    projectId: "auth-adfwc",
    storageBucket: "auth-adfwc.appspot.com",
    messagingSenderId: "221420792742",
    appId: "1:221420792742:web:f75515331cb4c5b4603d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const docRef = doc(db, "p", "dame");

  const boardElement = document.getElementById("board");
  const statusElement = document.getElementById("status");

  const IMAGES = {
    1: "../b/weiß.png",
    2: "../b/schwarz.png",
    11: "../b/weiß.png",
    22: "../b/schwarz.png"
  };

  // Spielstatus
  let gameState = {
    board: [],
    currentPlayer: 1,
    playerWhite: null,
    playerBlack: null,
    selected: null,
    myColor: 0  // 0 = Zuschauer, 1 = Weiß, 2 = Schwarz
  };

  function createInitialBoard() {
    const board = [];
    for (let r = 0; r < 8; r++) {
      board[r] = [];
      for (let c = 0; c < 8; c++) {
        if ((r + c) % 2 === 1) {
          if (r < 3) board[r][c] = 2;
          else if (r > 4) board[r][c] = 1;
          else board[r][c] = 0;
        } else {
          board[r][c] = 0;
        }
      }
    }
    return board;
  }

  function generateMyId() {
    const localIdKey = "damePlayerId";
    let myId = localStorage.getItem(localIdKey);
    if (!myId) {
      myId = Math.random().toString(36).substring(2, 10);
      localStorage.setItem(localIdKey, myId);
    }
    return myId;
  }

  async function joinGame() {
    const myId = generateMyId();

    const snap = await getDoc(docRef);
    if (!snap.exists()) {
      // Neues Spiel initialisieren
      await setDoc(docRef, {
        board: JSON.stringify(createInitialBoard()),
        currentPlayer: 1,
        playerWhite: null,
        playerBlack: null
      });
      return joinGame();
    }

    const data = snap.data();

    // Prüfen ob ich schon zugewiesen bin
    if (data.playerWhite === myId) return 1;
    if (data.playerBlack === myId) return 2;

    // Versuchen Slots zu reservieren
    if (!data.playerWhite) {
      await updateDoc(docRef, { playerWhite: myId });
      return 1;
    }
    if (!data.playerBlack) {
      await updateDoc(docRef, { playerBlack: myId });
      return 2;
    }

    // Spiel voll, Zuschauer
    return 0;
  }

  function renderBoard() {
    boardElement.innerHTML = "";
    for (let r = 0; r < 8; r++) {
      for (let c = 0; c < 8; c++) {
        const cell = document.createElement("div");
        cell.className = "cell " + (((r + c) % 2 === 0) ? "light" : "dark");

        const stone = gameState.board[r][c];
        if (stone) {
          const img = document.createElement("img");
          img.src = IMAGES[stone];
          img.className = "stone";
          cell.appendChild(img);
        }

        cell.onclick = () => handleClick(r, c);
        boardElement.appendChild(cell);
      }
    }
  }

  // Beispiel-Zug-Validierung: Zug erlaubt, wenn Zug vom Spieler und Feld leer
  function isValidMove(fromR, fromC, toR, toC) {
    if (gameState.myColor !== gameState.currentPlayer) return false; // Nicht am Zug
    if (gameState.board[fromR][fromC] !== gameState.myColor) return false; // Steintyp stimmt nicht
    if (gameState.board[toR][toC] !== 0) return false; // Zielfeld nicht frei
    // Hier bitte echte Dame-Regeln einsetzen (wegen Umfang jetzt nur Dummy)
    const dr = toR - fromR;
    const dc = toC - fromC;
    if (Math.abs(dr) === 1 && Math.abs(dc) === 1) return true;
    return false;
  }

  // Variablen für Zughandling
  let moveFrom = null;

  async function handleClick(r, c) {
    if (gameState.myColor === 0) {
      alert("Du bist nur Zuschauer.");
      return;
    }
    if (moveFrom === null) {
      // Erster Klick: Stein auswählen
      if (gameState.board[r][c] === gameState.myColor) {
        moveFrom = { r, c };
        renderBoard();
        highlightCell(r, c, true);
      }
    } else {
      // Zweiter Klick: Zug versuchen
      if (isValidMove(moveFrom.r, moveFrom.c, r, c)) {
        // Zug ausführen
        gameState.board[r][c] = gameState.board[moveFrom.r][moveFrom.c];
        gameState.board[moveFrom.r][moveFrom.c] = 0;
        gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
        moveFrom = null;
        await saveGame();
      } else {
        // Ungültig, Auswahl zurücksetzen
        moveFrom = null;
      }
      renderBoard();
    }
  }

  function highlightCell(r, c, selected) {
    const index = r * 8 + c;
    const cell = boardElement.children[index];
    if (cell) {
      if (selected) cell.classList.add("selected");
      else cell.classList.remove("selected");
    }
  }

  async function saveGame() {
    await updateDoc(docRef, {
      board: JSON.stringify(gameState.board),
      currentPlayer: gameState.currentPlayer
    });
  }

  async function setup() {
    gameState.myColor = await joinGame();
    statusElement.textContent =
      gameState.myColor === 1 ? "Du bist Spieler Weiß" :
      gameState.myColor === 2 ? "Du bist Spieler Schwarz" :
      "Spiel voll, du bist Zuschauer";

    onSnapshot(docRef, (snap) => {
      if (!snap.exists()) return;
      const data = snap.data();
      gameState.board = JSON.parse(data.board);
      gameState.currentPlayer = data.currentPlayer;
      gameState.playerWhite = data.playerWhite;
      gameState.playerBlack = data.playerBlack;
      renderBoard();
    });
  }

  setup();
</script>
</body>
</html>
