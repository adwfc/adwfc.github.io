<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Clipboard mit Text + Datei</title>
<style>
  body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 1rem; }
  input, textarea, button { width: 100%; font-size: 1rem; margin-top: 1rem; padding: 0.5rem; box-sizing: border-box; }
  #status { margin-top: 1rem; font-weight: bold; }
  #pinDisplay { margin-top: 0.5rem; font-weight: bold; color: blue; }
  #downloadLink { margin-top: 1rem; }
</style>
</head>
<body>

<h1>Clipboard mit Text & Datei</h1>

<label>PIN (zum Laden):</label>
<input type="text" id="pinInput" maxlength="2" placeholder="z.B. 42">

<button id="loadBtn">📥 Laden</button>

<label>Text:</label>
<textarea id="textInput" rows="6" placeholder="Text hier"></textarea>

<label>Datei auswählen (optional):</label>
<input type="file" id="fileInput">

<button id="saveBtn">💾 Speichern</button>

<div id="pinDisplay"></div>
<div id="status"></div>
<div id="downloadLink"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA2foolYwDeoTrfkynuhJu44lb5qDXHFwg",
  authDomain: "auth-adfwc.firebaseapp.com",
  projectId: "auth-adfwc",
  storageBucket: "auth-adfwc.appspot.com",
  messagingSenderId: "221420792742",
  appId: "1:221420792742:web:f75515331cb4c5b4603d"
};
initializeApp(firebaseConfig);
const db = getFirestore();

const el = id => document.getElementById(id);
const pinInput = el("pinInput"), textInput = el("textInput"), fileInput = el("fileInput");
const statusDiv = el("status"), pinDisplay = el("pinDisplay"), downloadLink = el("downloadLink");
const loadBtn = el("loadBtn"), saveBtn = el("saveBtn");

const setStatus = (msg, err=false) => {
  statusDiv.textContent = msg;
  statusDiv.style.color = err ? "red" : "green";
};
const genPin = () => Math.floor(Math.random()*100).toString().padStart(2, "0");

async function uploadFile(file) {
  const fd = new FormData();
  fd.append("file", file);
  const res = await fetch("https://tmpfiles.org/api/v1/upload", { method:"POST", body:fd });
  if (!res.ok) throw new Error("Upload fehlgeschlagen");
  const json = await res.json();
  return "https://tmpfiles.org" + json.data.url;
}

async function saveData() {
  const newPin = genPin(), content = textInput.value.trim();
  let url = null;
  setStatus("Speichere...");
  if (fileInput.files.length) {
    try { url = await uploadFile(fileInput.files[0]); }
    catch(e){ return setStatus(e.message, true); }
  }
  try {
    await setDoc(doc(db, "p", "clipboard"), { content, pin: newPin, url });
    pinInput.value = newPin;
    pinDisplay.textContent = "PIN: " + newPin;
    if (url) downloadLink.innerHTML = `<a href="${url}" target="_blank">📁 Datei herunterladen</a>`;
    else downloadLink.innerHTML = "";
    setStatus("Gespeichert ✅");
  } catch(e) {
    setStatus("Fehler: " + e.message, true);
  }
}

async function loadData() {
  const pin = pinInput.value.trim();
  if (!/^\d{2}$/.test(pin)) return setStatus("Ungültige PIN", true);
  setStatus("Lade...");
  try {
    const snap = await getDoc(doc(db, "p", "clipboard"));
    if (!snap.exists()) return setStatus("Keine Daten", true);
    const data = snap.data();
    if (data.pin !== pin) return setStatus("Falsche PIN", true);
    textInput.value = data.content || "";
    if (data.url) downloadLink.innerHTML = `<a href="${data.url}" target="_blank">📁 Datei herunterladen</a>`;
    else downloadLink.innerHTML = "";
    setStatus("Daten geladen ✅");
  } catch(e) {
    setStatus("Fehler: " + e.message, true);
  }
}

saveBtn.addEventListener("click", saveData);
loadBtn.addEventListener("click", loadData);
</script>

</body>
</html>
