<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Geräteübergreifende Zwischenablage mit Uguu + Firebase</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; padding: 1rem; }
  label { display: block; margin-top: 1rem; font-weight: bold; }
  input[type="text"], textarea, input[type="number"] {
    width: 100%; padding: 0.5rem; margin-top: 0.25rem;
    font-size: 1rem; box-sizing: border-box;
  }
  button {
    margin-top: 1rem; padding: 0.5rem 1rem; font-size: 1rem;
  }
  #fileLink {
    margin-top: 0.5rem;
    word-break: break-all;
  }
  #status {
    margin-top: 1rem; font-weight: bold;
    color: green;
  }
</style>
</head>
<body>

<h1>Zwischenablage mit Text & Datei</h1>

<label for="pinInput">2-stellige PIN</label>
<input type="text" id="pinInput" maxlength="2" pattern="[0-9]{2}" placeholder="z.B. 42" />

<label for="textInput">Text eingeben</label>
<textarea id="textInput" rows="6" placeholder="Hier Text speichern..."></textarea>

<label for="fileInput">Datei auswählen</label>
<input type="file" id="fileInput" />

<button id="saveBtn">Speichern</button>
<button id="loadBtn">Laden</button>
<button id="clearBtn">Löschen</button>

<div id="fileLink"></div>
<div id="status"></div>

<script>
  // Funktion zum Generieren einer zufälligen 2-stelligen PIN (00-99)
  function generateRandomPin() {
    return Math.floor(Math.random() * 100).toString().padStart(2, '0');
  }

  window.addEventListener('DOMContentLoaded', () => {
    const pinInput = document.getElementById('pinInput');
    if (!pinInput.value) {
      pinInput.value = generateRandomPin();
    }
  });
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    deleteField,
  } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

  // Firebase-Konfiguration hier einfügen:
  const firebaseConfig = {
    apiKey: "AIzaSyA2foolYwDeoTrfkynuhJu44lb5qDXHFwg",
    authDomain: "auth-adfwc.firebaseapp.com",
    projectId: "auth-adfwc",
    storageBucket: "auth-adfwc.appspot.com",
    messagingSenderId: "221420792742",
    appId: "1:221420792742:web:f75515331cb4c5b4603d",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const pinInput = document.getElementById("pinInput");
  const textInput = document.getElementById("textInput");
  const fileInput = document.getElementById("fileInput");
  const saveBtn = document.getElementById("saveBtn");
  const loadBtn = document.getElementById("loadBtn");
  const clearBtn = document.getElementById("clearBtn");
  const fileLinkDiv = document.getElementById("fileLink");
  const statusDiv = document.getElementById("status");

  function setStatus(msg, isError = false) {
    statusDiv.textContent = msg;
    statusDiv.style.color = isError ? "red" : "green";
  }

  // Datei zu Uguu hochladen, gibt die Download-URL zurück
  async function uploadFileToUguu(file) {
    const formData = new FormData();
    formData.append("file", file);

    try {
      setStatus("Datei wird hochgeladen...");
      const res = await fetch("https://uguu.se/upload.php", {
        method: "POST",
        body: formData,
      });
      const data = await res.json();
      if (data && data.success && data.files && data.files.length > 0) {
        setStatus("Datei erfolgreich hochgeladen.");
        return data.files[0].url;
      } else {
        throw new Error("Upload fehlgeschlagen");
      }
    } catch (e) {
      setStatus("Fehler beim Upload: " + e.message, true);
      throw e;
    }
  }

  async function saveData() {
    const pin = pinInput.value.trim();
    if (!/^\d{2}$/.test(pin)) {
      setStatus("Bitte eine gültige 2-stellige PIN eingeben.", true);
      return;
    }

    const text = textInput.value;
    let fileURL = null;

    if (fileInput.files.length > 0) {
      try {
        fileURL = await uploadFileToUguu(fileInput.files[0]);
      } catch {
        return;
      }
    }

    const docRef = doc(db, "p", pin);

    // Hole vorhandene Daten, um ggf. Datei-URL zu löschen, wenn keine neue hochgeladen wurde
    const existingDoc = await getDoc(docRef);

    const updateObj = { content: text };
    if (fileURL) {
      updateObj.fileURL = fileURL;
    } else if (existingDoc.exists() && existingDoc.data().fileURL) {
      // Keine neue Datei hochgeladen, alte Datei entfernen
      updateObj.fileURL = deleteField();
    }

    try {
      await setDoc(docRef, updateObj, { merge: true });
      setStatus("Daten erfolgreich gespeichert.");
      fileInput.value = "";
      loadData(); // sofort nachladen, um Link anzuzeigen
    } catch (e) {
      setStatus("Fehler beim Speichern: " + e.message, true);
    }
  }

  async function loadData() {
    const pin = pinInput.value.trim();
    if (!/^\d{2}$/.test(pin)) {
      setStatus("Bitte eine gültige 2-stellige PIN eingeben.", true);
      return;
    }

    const docRef = doc(db, "p", pin);
    try {
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        textInput.value = data.content || "";
        if (data.fileURL) {
          fileLinkDiv.innerHTML =
            `<a href="${data.fileURL}" target="_blank" rel="noopener noreferrer">Datei herunterladen</a>`;
        } else {
          fileLinkDiv.textContent = "";
        }
        setStatus("Daten geladen.");
      } else {
        setStatus("Keine Daten für diese PIN gefunden.", true);
        textInput.value = "";
        fileLinkDiv.textContent = "";
      }
    } catch (e) {
      setStatus("Fehler beim Laden: " + e.message, true);
    }
  }

  async function clearData() {
    const pin = pinInput.value.trim();
    if (!/^\d{2}$/.test(pin)) {
      setStatus("Bitte eine gültige 2-stellige PIN eingeben.", true);
      return;
    }
    const docRef = doc(db, "p", pin);
    try {
      await setDoc(
        docRef,
        { content: "", fileURL: deleteField() },
        { merge: true }
      );
      textInput.value = "";
      fileLinkDiv.textContent = "";
      setStatus("Daten gelöscht.");
    } catch (e) {
      setStatus("Fehler beim Löschen: " + e.message, true);
    }
  }

  saveBtn.addEventListener("click", saveData);
  loadBtn.addEventListener("click", loadData);
  clearBtn.addEventListener("click", clearData);
</script>

</body>
</html>
